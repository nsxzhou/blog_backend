# 博客系统数据库设计文档

## 一、总体设计

本博客系统采用多数据库协同工作的架构：
- MySQL：存储结构化数据，包括用户信息、文章元数据、分类、标签、评论等
- Redis：缓存热点数据，提高系统性能
- Elasticsearch：存储和检索文章内容，提供全文搜索功能
- 对象存储：用于存储图片等静态资源文件

## 二、MySQL数据库设计

### 1. 用户表(users)

```sql
CREATE TABLE `users` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(100) NOT NULL COMMENT '密码(加密)',
  `email` varchar(100) NOT NULL COMMENT '邮箱',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `bio` text DEFAULT NULL COMMENT '个人简介',
  `role` varchar(20) NOT NULL DEFAULT 'user' COMMENT '角色(admin/editor/user)',
  `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态(0:禁用,1:启用)',
  `last_login_at` datetime DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` varchar(50) DEFAULT NULL COMMENT '最后登录IP',
  `is_verified` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否验证邮箱',
  `verification_token` varchar(100) DEFAULT NULL COMMENT '验证令牌',
  `reset_password_token` varchar(100) DEFAULT NULL COMMENT '重置密码令牌',
  `reset_password_expires` datetime DEFAULT NULL COMMENT '重置密码过期时间',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `is_phone_verified` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否验证手机',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_username` (`username`),
  UNIQUE KEY `idx_email` (`email`),
  UNIQUE KEY `idx_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 2. 文章元数据表(articles)

```sql
CREATE TABLE `articles` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '文章ID',
  `title` varchar(255) NOT NULL COMMENT '文章标题',
  `summary` varchar(500) DEFAULT NULL COMMENT '文章摘要',
  `status` varchar(20) NOT NULL DEFAULT 'draft' COMMENT '状态(draft/published)',
  `view_count` int(11) NOT NULL DEFAULT 0 COMMENT '浏览量',
  `like_count` int(11) NOT NULL DEFAULT 0 COMMENT '点赞数',
  `comment_count` int(11) NOT NULL DEFAULT 0 COMMENT '评论数',
  `favorite_count` int(11) NOT NULL DEFAULT 0 COMMENT '收藏数',
  `author_id` int(11) NOT NULL COMMENT '作者ID',
  `category_id` int(11) DEFAULT NULL COMMENT '分类ID',
  `cover_image` varchar(255) DEFAULT NULL COMMENT '封面图片URL',
  `es_id` varchar(50) NOT NULL COMMENT 'Elasticsearch文档ID',
  `word_count` int(11) NOT NULL DEFAULT 0 COMMENT '字数统计',
  `read_time` int(11) NOT NULL DEFAULT 0 COMMENT '预计阅读时间(分钟)',
  `access_type` varchar(20) NOT NULL DEFAULT 'public' COMMENT '访问类型(public/private/password)',
  `password` varchar(100) DEFAULT NULL COMMENT '访问密码(加密)',
  `is_top` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否置顶',
  `is_original` tinyint(1) NOT NULL DEFAULT 1 COMMENT '是否原创',
  `source_url` varchar(255) DEFAULT NULL COMMENT '转载来源URL',
  `source_name` varchar(100) DEFAULT NULL COMMENT '转载来源名称',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `published_at` datetime DEFAULT NULL COMMENT '发布时间',
  PRIMARY KEY (`id`),
  KEY `idx_author_id` (`author_id`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_status` (`status`),
  KEY `idx_published_at` (`published_at`),
  KEY `idx_es_id` (`es_id`),
  KEY `idx_access_type` (`access_type`),
  KEY `idx_is_top` (`is_top`),
  CONSTRAINT `fk_articles_author` FOREIGN KEY (`author_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_articles_category` FOREIGN KEY (`category_id`) REFERENCES `categories` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章元数据表';
```

### 3. 文章版本表(article_versions)

```sql
CREATE TABLE `article_versions` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '版本ID',
  `article_id` int(11) NOT NULL COMMENT '文章ID',
  `title` varchar(255) NOT NULL COMMENT '文章标题',
  `content` text NOT NULL COMMENT '文章内容',
  `version` int(11) NOT NULL COMMENT '版本号',
  `created_by` int(11) NOT NULL COMMENT '创建用户ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_article_id` (`article_id`),
  KEY `idx_created_by` (`created_by`),
  KEY `idx_version` (`version`),
  CONSTRAINT `fk_versions_article` FOREIGN KEY (`article_id`) REFERENCES `articles` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_versions_user` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章版本表';
```

### 4. 分类表(categories)

```sql
CREATE TABLE `categories` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '分类ID',
  `name` varchar(50) NOT NULL COMMENT '分类名称',
  `description` text DEFAULT NULL COMMENT '分类描述',
  `order` int(11) NOT NULL DEFAULT 0 COMMENT '排序',
  `icon` varchar(255) DEFAULT NULL COMMENT '分类图标',
  `article_count` int(11) NOT NULL DEFAULT 0 COMMENT '文章数量',
  `is_visible` tinyint(1) NOT NULL DEFAULT 1 COMMENT '是否可见',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_name` (`name`),
  KEY `idx_order` (`order`),
  KEY `idx_is_visible` (`is_visible`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='分类表';
```

### 5. 标签表(tags)

```sql
CREATE TABLE `tags` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '标签ID',
  `name` varchar(50) NOT NULL COMMENT '标签名称',
  `article_count` int(11) NOT NULL DEFAULT 0 COMMENT '文章数量',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='标签表';
```

### 6. 图片表(images)

```sql
CREATE TABLE `images` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '图片ID',
  `url` varchar(255) NOT NULL COMMENT '图片URL',
  `path` varchar(255) NOT NULL COMMENT '存储路径',
  `filename` varchar(100) NOT NULL COMMENT '文件名',
  `size` int(11) NOT NULL COMMENT '文件大小(字节)',
  `width` int(11) DEFAULT NULL COMMENT '图片宽度',
  `height` int(11) DEFAULT NULL COMMENT '图片高度',
  `mime_type` varchar(50) NOT NULL COMMENT '文件类型',
  `user_id` int(11) NOT NULL COMMENT '上传用户ID',
  `usage_type` varchar(20) DEFAULT NULL COMMENT '用途类型(avatar/cover/content)',
  `article_id` int(11) DEFAULT NULL COMMENT '关联文章ID',
  `is_external` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否外部链接',
  `storage_type` varchar(20) NOT NULL DEFAULT 'local' COMMENT '存储类型(local/oss/cos/s3)',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_article_id` (`article_id`),
  KEY `idx_usage_type` (`usage_type`),
  KEY `idx_storage_type` (`storage_type`),
  CONSTRAINT `fk_images_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_images_article` FOREIGN KEY (`article_id`) REFERENCES `articles` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图片表';
```

### 7. 文章-标签关联表(article_tags)

```sql
CREATE TABLE `article_tags` (
  `article_id` int(11) NOT NULL COMMENT '文章ID',
  `tag_id` int(11) NOT NULL COMMENT '标签ID',
  PRIMARY KEY (`article_id`, `tag_id`),
  KEY `idx_tag_id` (`tag_id`),
  CONSTRAINT `fk_article_tags_article` FOREIGN KEY (`article_id`) REFERENCES `articles` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_article_tags_tag` FOREIGN KEY (`tag_id`) REFERENCES `tags` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章-标签关联表';
```

### 8. 评论表(comments)

```sql
CREATE TABLE `comments` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '评论ID',
  `content` text NOT NULL COMMENT '评论内容',
  `article_id` int(11) NOT NULL COMMENT '文章ID',
  `user_id` int(11) NOT NULL COMMENT '用户ID',
  `parent_id` int(11) DEFAULT NULL COMMENT '父评论ID',
  `status` varchar(20) NOT NULL DEFAULT 'pending' COMMENT '状态(pending/approved/rejected)',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_article_id` (`article_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_comments_article` FOREIGN KEY (`article_id`) REFERENCES `articles` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_comments_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_comments_parent` FOREIGN KEY (`parent_id`) REFERENCES `comments` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评论表';
```

### 9. 系统配置表(settings)

```sql
CREATE TABLE `settings` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '配置ID',
  `key` varchar(50) NOT NULL COMMENT '配置键',
  `value` text DEFAULT NULL COMMENT '配置值',
  `description` varchar(255) DEFAULT NULL COMMENT '配置描述',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_key` (`key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统配置表';
```

### 10. 用户登录记录表(login_logs)

```sql
CREATE TABLE `login_logs` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` int(11) NOT NULL COMMENT '用户ID',
  `ip` varchar(50) NOT NULL COMMENT 'IP地址',
  `user_agent` varchar(255) DEFAULT NULL COMMENT '用户代理',
  `status` tinyint(1) NOT NULL COMMENT '状态(0:失败,1:成功)',
  `login_type` varchar(20) NOT NULL DEFAULT 'password' COMMENT '登录类型(password/token/oauth)',
  `device_info` varchar(255) DEFAULT NULL COMMENT '设备信息',
  `location` varchar(100) DEFAULT NULL COMMENT '地理位置',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_login_logs_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户登录记录表';
```

### 11. 操作日志表(operation_logs)

```sql
CREATE TABLE `operation_logs` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` int(11) NOT NULL COMMENT '用户ID',
  `module` varchar(50) NOT NULL COMMENT '模块',
  `operation` varchar(50) NOT NULL COMMENT '操作',
  `description` varchar(255) DEFAULT NULL COMMENT '描述',
  `ip` varchar(50) NOT NULL COMMENT 'IP地址',
  `request_method` varchar(10) DEFAULT NULL COMMENT '请求方法',
  `request_url` varchar(255) DEFAULT NULL COMMENT '请求URL',
  `request_params` text DEFAULT NULL COMMENT '请求参数',
  `status_code` int(11) DEFAULT NULL COMMENT '状态码',
  `execution_time` int(11) DEFAULT NULL COMMENT '执行时间(ms)',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_module` (`module`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_operation_logs_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='操作日志表';
```

### 12. 用户关注表(user_follows)

```sql
CREATE TABLE `user_follows` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `follower_id` int(11) NOT NULL COMMENT '关注者ID',
  `followed_id` int(11) NOT NULL COMMENT '被关注者ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_follower_followed` (`follower_id`, `followed_id`),
  KEY `idx_followed_id` (`followed_id`),
  CONSTRAINT `fk_follow_follower` FOREIGN KEY (`follower_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_follow_followed` FOREIGN KEY (`followed_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户关注表';
```

### 13. 文章收藏表(favorites)

```sql
CREATE TABLE `favorites` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '收藏ID',
  `user_id` int(11) NOT NULL COMMENT '用户ID',
  `article_id` int(11) NOT NULL COMMENT '文章ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_user_article` (`user_id`, `article_id`),
  KEY `idx_article_id` (`article_id`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_favorites_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_favorites_article` FOREIGN KEY (`article_id`) REFERENCES `articles` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='收藏表';
```

### 14. 文章点赞表(article_likes)

```sql
CREATE TABLE `article_likes` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '点赞ID',
  `user_id` int(11) NOT NULL COMMENT '用户ID',
  `article_id` int(11) NOT NULL COMMENT '文章ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_user_article` (`user_id`, `article_id`),
  KEY `idx_article_id` (`article_id`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_likes_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_likes_article` FOREIGN KEY (`article_id`) REFERENCES `articles` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章点赞表';
```

### 15. 评论点赞表(comment_likes)

```sql
CREATE TABLE `comment_likes` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '点赞ID',
  `user_id` int(11) NOT NULL COMMENT '用户ID',
  `comment_id` int(11) NOT NULL COMMENT '评论ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_user_comment` (`user_id`, `comment_id`),
  KEY `idx_comment_id` (`comment_id`),
  CONSTRAINT `fk_comment_likes_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_comment_likes_comment` FOREIGN KEY (`comment_id`) REFERENCES `comments` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评论点赞表';
```

### 16. 用户通知表(notifications)

```sql
CREATE TABLE `notifications` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '通知ID',
  `user_id` int(11) NOT NULL COMMENT '接收用户ID',
  `sender_id` int(11) DEFAULT NULL COMMENT '发送用户ID',
  `article_id` int(11) DEFAULT NULL COMMENT '相关文章ID',
  `comment_id` int(11) DEFAULT NULL COMMENT '相关评论ID',
  `type` varchar(20) NOT NULL COMMENT '类型(comment/like/follow/system)',
  `content` text NOT NULL COMMENT '通知内容',
  `is_read` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否已读',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_sender_id` (`sender_id`),
  KEY `idx_article_id` (`article_id`),
  KEY `idx_comment_id` (`comment_id`),
  KEY `idx_is_read` (`is_read`),
  KEY `idx_type` (`type`),
  CONSTRAINT `fk_notify_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_notify_sender` FOREIGN KEY (`sender_id`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_notify_article` FOREIGN KEY (`article_id`) REFERENCES `articles` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_notify_comment` FOREIGN KEY (`comment_id`) REFERENCES `comments` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通知表';
```

## 三、Redis缓存设计

Redis主要用于缓存热点数据，提高系统性能。以下是具体的缓存设计：

### 1. 用户信息缓存

```
# 用户信息 (Hash结构)
key: user:{userId}
fields:
  - username: 用户名
  - nickname: 昵称
  - avatar: 头像URL
  - role: 角色
  - email: 邮箱
  - bio: 个人简介
过期时间: 1小时

# 用户认证信息 (String结构)
key: user:auth:{userId}
value: 密码哈希
过期时间: 30分钟
```

### 2. 文章缓存

```
# 文章元数据缓存 (Hash结构)
key: article:{articleId}
fields:
  - title: 标题
  - author_id: 作者ID
  - category_id: 分类ID
  - view_count: 浏览量
  - like_count: 点赞数
  - comment_count: 评论数
  - favorite_count: 收藏数
  - status: 状态
  - published_at: 发布时间
  - es_id: ES文档ID
  - access_type: 访问类型
  - is_top: 是否置顶
过期时间: 30分钟

# 文章浏览量计数器 (String结构)
key: article:view:{articleId}
value: 浏览量
过期时间: 1小时 (定期同步到MySQL)

# 文章点赞计数器 (String结构)
key: article:like:{articleId}
value: 点赞数
过期时间: 1小时 (定期同步到MySQL)

# 文章收藏计数器 (String结构)
key: article:favorite:{articleId}
value: 收藏数
过期时间: 1小时 (定期同步到MySQL)
```

### 3. 首页文章列表缓存

```
# 首页最新文章列表 (List结构)
key: article:latest
value: 文章ID列表
过期时间: 10分钟

# 首页推荐文章列表 (List结构)
key: article:recommended
value: 文章ID列表
过期时间: 10分钟

# 热门文章列表 (Sorted Set结构)
key: article:hot
value: 文章ID集合 (score为热度值)
过期时间: 1小时

# 置顶文章列表 (List结构)
key: article:top
value: 文章ID列表
过期时间: 30分钟
```

### 4. 分类和标签缓存

```
# 所有分类列表 (Hash结构)
key: categories
fields:
  - {categoryId}: 分类名称
过期时间: 1小时

# 所有标签列表 (Hash结构)
key: tags
fields:
  - {tagId}: 标签名称
过期时间: 1小时

# 文章标签关联 (Set结构)
key: article:tags:{articleId}
value: 标签ID集合
过期时间: 30分钟

# 标签关联的文章 (Set结构)
key: tag:articles:{tagId}
value: 文章ID集合
过期时间: 30分钟

# 分类关联的文章 (Sorted Set结构)
key: category:articles:{categoryId}
value: 文章ID集合 (score为发布时间)
过期时间: 30分钟
```

### 5. 用户认证相关

```
# JWT黑名单 (Set结构)
key: jwt:blacklist
value: 失效的token集合
过期时间: 根据token有效期设置

# 用户会话 (String结构)
key: session:{sessionId}
value: 用户ID
过期时间: 根据会话有效期设置

# 登录失败计数器 (String结构)
key: login:fail:{ip}
value: 失败次数
过期时间: 30分钟

# 登录锁定 (String结构)
key: login:lock:{ip}
value: 锁定时间戳
过期时间: 根据锁定时间设置
```

### 6. 评论缓存

```
# 文章评论列表 (List结构)
key: article:comments:{articleId}
value: 评论ID列表
过期时间: 15分钟

# 评论点赞计数器 (String结构)
key: comment:like:{commentId}
value: 点赞数
过期时间: 30分钟
```

### 7. 系统配置缓存

```
# 系统配置 (Hash结构)
key: settings
fields:
  - {key}: 配置值
过期时间: 1天
```

### 8. 访问统计

```
# 每日访问IP统计 (HyperLogLog结构)
key: stats:daily:ip:{yyyy-MM-dd}
value: IP地址集合
过期时间: 7天

# 每日PV统计 (String结构)
key: stats:daily:pv:{yyyy-MM-dd}
value: PV计数
过期时间: 7天

# 实时在线用户 (Set结构)
key: online:users
value: 用户ID集合
过期时间: 无 (通过心跳维护)
```

### 9. 用户社交关系缓存

```
# 用户关注者 (Set结构)
key: user:followers:{userId}
value: 关注者ID集合
过期时间: 1小时

# 用户关注的人 (Set结构)
key: user:following:{userId}
value: 被关注者ID集合
过期时间: 1小时

# 用户收藏的文章 (Sorted Set结构)
key: user:favorites:{userId}
value: 文章ID集合 (score为收藏时间)
过期时间: 30分钟

# 用户点赞的文章 (Set结构)
key: user:liked:articles:{userId}
value: 文章ID集合
过期时间: 30分钟

# 用户点赞的评论 (Set结构)
key: user:liked:comments:{userId}
value: 评论ID集合
过期时间: 30分钟
```

### 10. 通知系统缓存

```
# 用户未读通知计数 (String结构)
key: user:unread_notifications:{userId}
value: 未读通知数
过期时间: 10分钟

# 用户最近通知 (List结构)
key: user:recent_notifications:{userId}
value: 通知ID列表
过期时间: 30分钟
```

### 11. 图片缓存

```
# 热门图片缓存 (Hash结构)
key: image:{imageId}
fields:
  - url: 图片URL
  - path: 存储路径
  - filename: 文件名
  - size: 文件大小
  - width: 宽度
  - height: 高度
过期时间: 1小时
```

## 四、Elasticsearch文档设计

Elasticsearch主要用于存储文章内容并提供全文搜索功能。以下是文章索引的设计：

### 1. 文章索引定义

```json
{
  "mappings": {
    "properties": {
      "id": { 
        "type": "keyword" 
      },
      "mysql_id": { 
        "type": "integer" 
      },
      "title": { 
        "type": "text", 
        "analyzer": "ik_max_word", 
        "search_analyzer": "ik_smart",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "content": { 
        "type": "text", 
        "analyzer": "ik_max_word", 
        "search_analyzer": "ik_smart" 
      },
      "summary": { 
        "type": "text", 
        "analyzer": "ik_max_word", 
        "search_analyzer": "ik_smart" 
      },
      "author_id": { 
        "type": "integer" 
      },
      "author_name": { 
        "type": "keyword" 
      },
      "category_id": { 
        "type": "integer" 
      },
      "category_name": { 
        "type": "keyword" 
      },
      "tags": { 
        "type": "keyword" 
      },
      "status": { 
        "type": "keyword" 
      },
      "view_count": {
        "type": "integer"
      },
      "like_count": {
        "type": "integer"
      },
      "comment_count": {
        "type": "integer"
      },
      "favorite_count": {
        "type": "integer"
      },
      "word_count": {
        "type": "integer"
      },
      "read_time": {
        "type": "integer"
      },
      "access_type": {
        "type": "keyword"
      },
      "is_top": {
        "type": "boolean"
      },
      "is_original": {
        "type": "boolean"
      },
      "source_url": {
        "type": "keyword"
      },
      "source_name": {
        "type": "keyword"
      },
      "cover_image": {
        "type": "keyword"
      },
      "created_at": { 
        "type": "date", 
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis" 
      },
      "updated_at": { 
        "type": "date", 
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis" 
      },
      "published_at": { 
        "type": "date", 
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis" 
      }
    }
  },
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "analysis": {
      "analyzer": {
        "ik_smart": {
          "type": "custom",
          "tokenizer": "ik_smart",
          "filter": ["lowercase"]
        },
        "ik_max_word": {
          "type": "custom",
          "tokenizer": "ik_max_word",
          "filter": ["lowercase"]
        }
      }
    }
  }
}
```

### 2. 文章文档示例

```json
{
  "id": "article_123456",
  "mysql_id": 123456,
  "title": "Gin框架入门教程",
  "content": "# Gin框架入门\n\n## 简介\nGin是一个用Go语言编写的Web框架...(文章完整内容)",
  "summary": "本文介绍了Gin框架的基本使用方法和核心特性",
  "author_id": 1001,
  "author_name": "张三",
  "category_id": 5,
  "category_name": "Go教程",
  "tags": ["Gin", "Go", "Web框架", "后端开发"],
  "status": "published",
  "view_count": 1520,
  "like_count": 45,
  "comment_count": 13,
  "favorite_count": 28,
  "word_count": 3500,
  "read_time": 15,
  "access_type": "public",
  "is_top": false,
  "is_original": true,
  "cover_image": "https://example.com/images/covers/gin-tutorial.jpg",
  "created_at": "2023-04-15 10:30:00",
  "updated_at": "2023-04-15 14:20:00",
  "published_at": "2023-04-15 15:00:00"
}
```

### 3. 搜索优化策略

为了提高搜索效率和准确性，采用以下策略：

1. **分词优化**：
   - 标题和内容使用`ik_max_word`分词器进行索引，提取尽可能多的词汇
   - 搜索时使用`ik_smart`分词器，提取精准的关键词

2. **权重设置**：
   - 标题字段权重高于内容字段
   - 标签字段权重高于普通内容

3. **搜索增强**：
   - 支持拼音搜索
   - 支持同义词扩展
   - 支持错误纠正

4. **过滤策略**：
   - 只搜索已发布的文章（status=published）
   - 根据访问权限过滤（access_type=public）
   - 可按分类、标签、作者等条件组合筛选

### 4. 实时同步机制

为保证MySQL与Elasticsearch数据一致性，采用以下机制：

1. **事务操作**：
   - 博客文章更新时，在同一事务中同步更新MySQL和Elasticsearch
   - 如果其中一个操作失败，整个事务回滚

2. **定时校验**：
   - 定期对比MySQL和Elasticsearch数据，修复不一致部分
   - 支持全量重建索引功能

3. **日志记录**：
   - 记录所有同步操作
   - 记录同步失败的情况，便于手动修复

## 五、数据同步策略

### 1. MySQL与Elasticsearch数据同步

当文章发生创建、更新或删除操作时，需要同步更新Elasticsearch中的文档：

1. **创建文章**：
   - 先在MySQL中创建文章元数据记录，获取MySQL中的文章ID
   - 然后在Elasticsearch中创建文章文档，并将ES文档ID回写到MySQL

2. **更新文章**：
   - 更新MySQL中的文章元数据
   - 同步更新Elasticsearch中的文章文档
   - 更新文章版本表记录

3. **删除文章**：
   - 先删除Elasticsearch中的文档
   - 然后删除MySQL中的文章元数据及关联数据

4. **批量操作**：
   - 使用消息队列处理大批量数据同步
   - 支持异步更新非关键字段

### 2. Redis与MySQL数据同步

1. **定时同步**：
   - 设置定时任务，定期将Redis中的浏览量、点赞数等数据同步到MySQL
   - 系统负载较低时执行同步，避免高峰期操作

2. **触发同步**：
   - 当数据变化幅度达到阈值时，触发同步操作（例如点赞数变化超过100）
   - 系统重要操作（如文章发布、删除）后强制同步关联计数

3. **双写策略**：
   - 对于重要数据，采用先写MySQL再写Redis的策略，确保数据一致性
   - 非关键数据（如浏览量）可以先写Redis，再异步同步到MySQL

4. **缓存失效策略**：
   - 更新MySQL数据后，主动使相关Redis缓存失效
   - 采用延迟双删策略：更新前删除缓存，更新后再次删除缓存

## 六、索引优化

### 1. MySQL索引优化

已在表结构中定义了必要的索引，包括：
- 主键索引
- 外键索引
- 常用查询条件索引（如status、published_at等）
- 唯一索引（如username、email等）

额外的索引优化策略：
- 复合索引设计：根据查询模式创建适当的复合索引
- 索引覆盖：尽量使用索引覆盖查询，减少回表操作
- 部分索引：对于大字段，考虑使用前缀索引
- 定期维护：分析慢查询日志，优化相关索引

### 2. Elasticsearch索引优化

1. **分片与副本设置**：
   - 设置了3个分片和1个副本，可根据数据量和服务器资源进行调整
   - 考虑时间序列索引策略，按月或按季度创建索引

2. **分词器选择**：
   - 使用IK分词器，支持中文分词
   - 建立字段多级索引，如title字段既有text类型支持全文搜索，又有keyword类型支持精确匹配
   - 自定义分析器，适应特定业务场景

3. **更新策略**：
   - 对于频繁更新的字段，考虑使用脚本更新而非文档替换
   - 批量更新使用bulk API，提高性能

4. **查询优化**：
   - 合理使用filter和query，降低评分开销
   - 使用scroll API处理大结果集
   - 设置合理的分页大小，避免深度分页问题

## 七、性能优化建议

### 1. MySQL优化

1. **连接管理**：
   - 使用连接池管理数据库连接
   - 合理设置连接池大小和超时参数

2. **查询优化**：
   - 编写高效SQL，避免全表扫描
   - 使用适当的JOIN策略
   - 合理使用子查询和临时表

3. **表结构优化**：
   - 根据查询特点调整表结构和索引
   - 对大表考虑分区策略
   - 选择合适的存储引擎（InnoDB）和字符集（utf8mb4）

4. **配置优化**：
   - 调整缓冲池大小
   - 优化日志写入策略
   - 根据服务器资源调整并发参数

### 2. Redis优化

1. **数据结构选择**：
   - 选择合适的数据结构（String、Hash、List、Set、Sorted Set等）
   - 使用位图(Bitmap)和HyperLogLog等高效结构处理特定场景

2. **内存管理**：
   - 合理设置数据过期时间
   - 使用内存策略（如LRU、LFU）
   - 监控内存使用情况，避免内存溢出
   - 定期清理过期数据

3. **性能提升**：
   - 使用Pipeline批量操作
   - 减少大key的使用
   - 合理使用Redis事务
   - 考虑使用Redis集群分担负载

4. **持久化策略**：
   - 根据业务需求选择RDB和AOF持久化策略
   - 设置合理的持久化频率，平衡性能和数据安全

### 3. Elasticsearch优化

1. **集群管理**：
   - 定期进行索引合并
   - 监控集群健康状态
   - 根据数据增长调整节点配置

2. **索引管理**：
   - 使用索引别名管理索引生命周期
   - 实现索引滚动更新策略
   - 对历史数据设置较低的副本数

3. **查询优化**：
   - 使用查询缓存
   - 避免使用脚本评分
   - 使用聚合缓存
   - 预热查询提高热点数据访问速度

4. **资源优化**：
   - 优化JVM配置
   - 调整刷新间隔
   - 对大文档考虑压缩或分段存储策略

### 4. 应用层优化

1. **缓存策略**：
   - 多级缓存设计（本地缓存+Redis分布式缓存）
   - 使用Redis缓存热点数据
   - 实现缓存预热机制

2. **查询优化**：
   - 分页查询时限制页面大小
   - 使用适当的排序策略
   - 实现数据延迟加载

3. **并发控制**：
   - 使用乐观锁处理并发更新
   - 合理设置线程池参数
   - 实现请求限流和熔断机制

4. **监控与维护**：
   - 实现全面的性能监控系统
   - 定期分析性能瓶颈
   - 建立自动告警机制

## 八、安全措施

1. **数据安全**：
   - 敏感数据加密存储
   - 定期数据备份
   - 多地容灾策略

2. **访问控制**：
   - 严格的权限管理
   - API访问控制
   - 防止SQL注入攻击

3. **防护机制**：
   - 实现CSRF防护
   - XSS攻击防御
   - 敏感操作验证码保护
   - DDoS防护策略

## 九、总结

本博客系统的数据库设计采用了MySQL、Redis和Elasticsearch多种数据库协同工作的架构，各司其职：

- **MySQL**：负责存储结构化数据，包括用户信息、文章元数据、分类、标签等基础数据
- **Redis**：作为高性能缓存，存储热点数据，降低数据库压力
- **Elasticsearch**：专职全文检索，提供高效的文章搜索功能
- **对象存储**：存储图片等静态资源，提供高可用的访问服务

系统通过精心设计的数据同步机制，确保多种数据存储之间的数据一致性。同时，通过合理的索引设计和性能优化策略，保证系统在高并发访问下依然能够提供良好的用户体验。

该设计兼顾了功能完整性、性能要求和扩展性，为博客系统提供了坚实的数据基础。 