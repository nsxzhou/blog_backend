# 图片模块使用说明

## 概述

图片模块提供了完整的图片管理功能，支持图片上传、查询、更新、删除等操作。支持两种存储方式：
- **本地存储**：图片保存在服务器本地文件系统
- **腾讯云COS存储**：图片保存在腾讯云对象存储服务

## 功能特性

### 核心功能
- ✅ 图片上传（支持多种格式：JPEG、PNG、GIF、WebP）
- ✅ 图片查询（支持多种条件筛选）
- ✅ 图片更新（修改使用类型、关联文章等）
- ✅ 图片删除（单个删除、批量删除）
- ✅ 图片统计（存储大小、数量统计等）

### 存储支持
- ✅ 本地文件系统存储
- ✅ 腾讯云COS存储
- ✅ 自动获取图片尺寸
- ✅ 文件类型验证
- ✅ 文件大小限制（默认10MB）

### 使用场景
- **头像图片** (`avatar`)：用户头像
- **封面图片** (`cover`)：文章封面、分类封面等
- **内容图片** (`content`)：文章内容中的图片

## API 接口

### 1. 上传图片
```http
POST /api/images/upload
Authorization: Bearer <token>
Content-Type: multipart/form-data

Form Data:
- image: 图片文件
- usage_type: 使用类型 (avatar/cover/content)
- article_id: 文章ID (可选，内容图片时需要)
- storage_type: 存储类型 (local/cos，可选，默认local)
```

**响应示例：**
```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "id": 1,
    "url": "/uploads/images/1703123456789.jpg",
    "path": "uploads/images/1703123456789.jpg",
    "filename": "avatar.jpg",
    "size": 15360,
    "width": 200,
    "height": 200,
    "mime_type": "image/jpeg",
    "usage_type": "avatar",
    "storage_type": "local"
  }
}
```

### 2. 获取图片列表
```http
GET /api/images?page=1&page_size=20&usage_type=cover&storage_type=local
```

**查询参数：**
- `page`: 页码（必填）
- `page_size`: 每页数量（必填，5-50）
- `usage_type`: 使用类型（可选）
- `user_id`: 用户ID（可选）
- `article_id`: 文章ID（可选）
- `storage_type`: 存储类型（可选）
- `is_external`: 是否外链（可选，0/1）
- `start_date`: 开始日期（可选）
- `end_date`: 结束日期（可选）

### 3. 获取当前用户图片
```http
GET /api/images/my?page=1&page_size=20
Authorization: Bearer <token>
```

### 4. 获取图片详情
```http
GET /api/images/{id}
```

### 5. 更新图片信息
```http
PUT /api/images/{id}
Authorization: Bearer <token>
Content-Type: application/json

{
  "usage_type": "cover",
  "article_id": 123
}
```

### 6. 删除图片
```http
DELETE /api/images/{id}
Authorization: Bearer <token>
```

### 7. 批量删除图片
```http
POST /api/images/batch-delete
Authorization: Bearer <token>
Content-Type: application/json

{
  "image_ids": [1, 2, 3]
}
```

### 8. 获取图片统计数据（管理员）
```http
GET /api/images/statistics?start_date=2023-01-01&end_date=2023-12-31
Authorization: Bearer <admin_token>
```

### 9. 根据使用类型获取图片
```http
GET /api/images/type/{type}?page=1&page_size=20
```

### 10. 根据文章ID获取图片
```http
GET /api/images/article/{article_id}?page=1&page_size=20
```

### 11. 获取存储配置
```http
GET /api/images/config
```

## 配置说明

### 腾讯云COS配置
在配置文件中需要添加以下配置：

```yaml
tencent_cos:
  secret_id: "您的SecretId"
  secret_key: "您的SecretKey"
  bucket_url: "https://您的存储桶名称.cos.地域.myqcloud.com"
```

### 存储配置
- **最大文件大小**：10MB
- **支持格式**：JPEG、PNG、GIF、WebP
- **本地存储路径**：`uploads/images/`
- **文件命名规则**：时间戳 + 原扩展名

## 权限说明

### 公开权限
- 获取图片详情
- 获取图片列表
- 获取存储配置
- 根据条件查询图片

### 登录用户权限
- 上传图片
- 获取自己的图片列表
- 更新自己的图片信息
- 删除自己的图片
- 批量删除自己的图片

### 管理员权限
- 获取图片统计数据
- 查看所有用户的图片

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 400 | 参数错误（文件格式不支持、文件过大等） |
| 401 | 未授权（需要登录） |
| 403 | 权限不足（非图片所有者、非管理员） |
| 404 | 图片不存在 |
| 500 | 服务器内部错误（上传失败、数据库错误等） |

## 使用示例

### 前端上传图片示例

```javascript
// 上传头像
const uploadAvatar = async (file) => {
  const formData = new FormData();
  formData.append('image', file);
  formData.append('usage_type', 'avatar');
  formData.append('storage_type', 'cos'); // 使用腾讯云COS

  try {
    const response = await fetch('/api/images/upload', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: formData
    });
    
    const result = await response.json();
    if (result.code === 200) {
      console.log('上传成功:', result.data.url);
    }
  } catch (error) {
    console.error('上传失败:', error);
  }
};

// 获取文章相关图片
const getArticleImages = async (articleId) => {
  try {
    const response = await fetch(`/api/images/article/${articleId}?page=1&page_size=50`);
    const result = await response.json();
    if (result.code === 200) {
      return result.data.items;
    }
  } catch (error) {
    console.error('获取图片失败:', error);
  }
};
```

### 后端集成示例

```go
// 在文章中使用图片
func (s *ArticleService) CreateWithImages(req *CreateArticleRequest) error {
    // 1. 创建文章
    article := &model.Article{
        Title:   req.Title,
        Content: req.Content,
        // ...
    }
    
    if err := s.db.Create(article).Error; err != nil {
        return err
    }
    
    // 2. 更新图片关联
    if len(req.ImageIDs) > 0 {
        err := s.db.Model(&model.Image{}).
            Where("id IN ?", req.ImageIDs).
            Updates(map[string]interface{}{
                "article_id": article.ID,
                "usage_type": "content",
            }).Error
        if err != nil {
            return err
        }
    }
    
    return nil
}
```

## 注意事项

1. **文件安全**：上传的文件会进行格式验证，只允许图片格式
2. **存储清理**：删除图片时会自动删除本地文件，但腾讯云COS需要手动清理
3. **权限控制**：用户只能操作自己上传的图片
4. **软删除**：数据库中的图片记录采用软删除，便于数据恢复
5. **异步操作**：本地文件删除采用异步操作，避免阻塞请求
6. **错误处理**：上传失败时会自动清理已上传的文件

## 最佳实践

1. **图片压缩**：建议在前端进行图片压缩后再上传
2. **CDN加速**：腾讯云COS可配置CDN加速
3. **批量操作**：大量图片操作建议使用批量接口
4. **监控统计**：定期查看存储统计，合理管理存储空间
5. **备份策略**：重要图片建议同时使用本地和云存储 